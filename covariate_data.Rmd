---
title: "covariate_data"
output:
#  pdf_document:
#    toc: yes
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Introduction
========================================================
Covariate analysis for 2015 rare data collected by Ohio State.

Distribution
========================================================
The git repo holding this code is available at:
https://github.com/puruckertom/rare_pollen

Computational environment
========================================================

```{r eval=FALSE, echo=FALSE}
#library(installr) #windows only currently
#updateR()
```
Version and installed libraries.
```{r eval=TRUE, echo=TRUE}
verbose_output = TRUE

if(verbose_output){
  print(Sys.info()[4])
  R.Version()$version.string
}
#check to see if needed packages are installed
list.of.packages <- c("ggplot2", "dplyr","nlme")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#load relevant packages
library(MASS)
library(dplyr, warn.conflicts = FALSE)
library(ggplot2)
library(reshape2)
library(nlme,warn.conflicts=FALSE)
library(lme4,warn.conflicts=FALSE)

if(verbose_output){
  print("list of loaded packages: ")
  print((.packages()))
}
```

```{r eval=TRUE, echo=FALSE}
if(Sys.info()[4]=="DZ2626UTPURUCKE"){
  rare_data <- "k:\\git\\rare_pollen\\"
} else if(Sys.info()[4]=="stp-air.local" || Sys.info()[4]=="stp-air"){
  rare_data <- path.expand("~/git/rare_pollen/")
}else if(Sys.info()[4]=="Erins-MacBook"){
  rare_data <- "~/Documents/GitHub/rare_pollen/"
} else
    rare_data <- paste(getwd(),"/",sep="")

osu_data <- paste(rare_data, "data_in/", sep="")
```

Analytical data
========================================================
Original file with observational data: 
https://github.com/puruckertom/rare_pollen/blob/master/data_in/rare_data_osu_2015.csv

```{r eval=TRUE, echo=TRUE}
##################
#the data sets
##################
#import raw data - everything
file.exists(paste(osu_data,"CDRC_2017EPA_FP_DBT.csv",sep=""))
osu_covariate <- read.table(paste(osu_data,"CDRC_2017EPA_FP_DBT.csv",sep=""), header = TRUE, sep = ",",strip.white=T,na.strings="")

## restart here

#melt to long format
#keepers <- colnames(osu_obs)[1:11] #through media column
#osu_concs <- melt(osu_obs, id.vars = keepers, variable.name = "neonic", #value.name = "conc")
#dim(osu_concs)
#colnames(osu_concs)

#add detected field and numerical concentration
#osu_concs$conc
#osu_concs$detected <- ifelse(grepl("<", osu_concs$conc),0,1)
#osu_concs$conc2 <- as.numeric(gsub("< ", "", osu_concs$conc))
#View(osu_concs)

```

####Cleaning the data

```{r eval=TRUE, echo=TRUE}
osu_covariate <- osu_covariate[,1:23]
colnames(osu_covariate)[c(4,6)] <- c("planting","per_corn")
osu_covariate$planting<- factor(osu_covariate$planting,labels=c("no","yes"))
neonics_cols <- which(grepl("DBT|FP",colnames(osu_covariate))& !grepl("sample_id",colnames(osu_covariate)))

#Create categorical vars which track whether any given neonic was detected
neonics_detected <- as.data.frame(lapply(osu_covariate[,neonics_cols],function(x) ifelse((grepl("<",x) | is.na(x)),0,1)))
colnames(neonics_detected) <- paste(colnames(neonics_detected),"detected",sep="_")
osu_covariate <- cbind(osu_covariate,neonics_detected)

#Create two single categorical vars which tracks whether ANY neonic was detected in dead bees or pollen
osu_covariate$DBT_any_detected <- ifelse(rowSums(neonics_detected[,grepl("DBT",colnames(neonics_detected))]) > 0,1,0)
osu_covariate$FP_any_detected <- ifelse(rowSums(neonics_detected[,grepl("FP",colnames(neonics_detected))]) > 0,1,0)


#convert neonic concs to numeric
osu_covariate[,neonics_cols] <- as.numeric(gsub("< ","",as.matrix(osu_covariate[,neonics_cols])))

#create variables for total neonic loads
osu_covariate$DBT_total_neonic <- rowSums(osu_covariate[,grepl("DBT",colnames(osu_covariate))& !grepl("sample_id|detected",colnames(osu_covariate))])

osu_covariate$FP_total_neonic <- rowSums(osu_covariate[,grepl("FP",colnames(osu_covariate))& !grepl("sample_id|detected",colnames(osu_covariate))])

neonics_cols <- c(neonics_cols,which(colnames(osu_covariate) %in% c("DBT_total_neonic","FP_total_neonic")))

#write.csv(osu_covariate,"data_in/CDRC_2017EPA_FP_DBT_clean.csv",row.names=FALSE) #output a csv for the cleaned data

attach(osu_covariate)
str(osu_covariate)


```


Exploring the data
========================================================

<br>

#####Time to make a quick scan for correlations in the data....

<br>

#####Are there correlations between mortality and any of the neonic concentrations?

```{r eval=TRUE, echo=TRUE}
for(i in 1:length(neonics_cols)){
  cor <- cor.test(osu_covariate$mortality, osu_covariate[,neonics_cols[i]])
  cat("\n",paste("Correlation between mortality and ",colnames(osu_covariate[,neonics_cols])[i],":",sep=""),paste("Pearson's correlation: ",round(cor$estimate,2),', p-value: ',ifelse(cor$p.value < 0.001,"<0.001",round(cor$p.value,3)),ifelse(cor$p.value < 0.05,"***",""),sep=""),sep="\n")
}

```
<br>

So, we see strong positive correlations between mortality and two neonics, thiamethoxam and clothianidin, but for field pollen samples only. We may want to focus some analyses on these two chemicals. There is also a significant positive correlation for total pollen load of neonics
<br><br>

#####Now let's look at some correlations between the percent corn and the neonics

```{r eval=TRUE, echo=TRUE}

for(i in 1:length(neonics_cols)){
  cor <- cor.test(osu_covariate$per_corn, osu_covariate[,neonics_cols[i]])
  cat("\n",paste("Correlation between % corn and ",colnames(osu_covariate[,neonics_cols])[i],":",sep=""),paste("Pearson's correlation: ",round(cor$estimate,2),', p-value: ',ifelse(cor$p.value < 0.001,"<0.001",round(cor$p.value,3)),ifelse(cor$p.value < 0.05,"***",""),sep=""),sep="\n")
}

```
<br>

It looks like there are near-significant postive correlations between % corn and these same two neonics (thiamethoxam and clothianidin) in pollen, as well as total pollen load. 
<br><br>

#####What if we just look at this relationship during defined corn planting periods?

```{r eval=TRUE, echo=TRUE}

for(i in 1:length(neonics_cols)){
  cor <- cor.test(subset(osu_covariate,planting=="yes")$per_corn, subset(osu_covariate,planting=="yes")[,neonics_cols[i]])
  cat("\n",paste("Correlation between % corn and ",colnames(osu_covariate[,neonics_cols])[i],":",sep=""),paste("Pearson's correlation: ",round(cor$estimate,2),', p-value: ',ifelse(cor$p.value < 0.001,"<0.001",round(cor$p.value,3)),ifelse(cor$p.value < 0.05,"***",""),sep=""),sep="\n")
}

```
<br>

During planting periods, there are significant correlations between thiamethoxam and clothianidin in pollen, as well as total pollen load. 
<br><br>

#####Let's take a look at some of these relationships graphically:


```{r eval=TRUE, echo=TRUE}

interesting_neonics <- c("FP_thiamethoxam","FP_clothianidin","FP_total_neonic")
interesting_neonics_binomial <- c("FP_thiamethoxam_detected","FP_clothianidin_detected","FP_any_detected")

for(i in 1:length(interesting_neonics)){
  plot(per_corn,osu_covariate[,interesting_neonics[i]],pch=19,main=paste("% corn vs.",interesting_neonics[i]),ylab=paste(interesting_neonics[i],"ng g-1"),xlab="Percent corn")
  
}

for(i in 1:length(interesting_neonics)){
  plot(osu_covariate[,interesting_neonics[i]],mortality,pch=19,main=paste(interesting_neonics[i],"vs mortality"),xlab=paste(interesting_neonics[i],"ng g-1"),ylab="Mortality (relative to hive avg)")
  abline(h=0)
}


for(i in 1:length(interesting_neonics_binomial)){
  plot(factor(osu_covariate[,interesting_neonics_binomial[i]],levels = c(0,1),labels=c("No","Yes")),mortality,pch=19,main=paste("Detection of",gsub("_detected","",interesting_neonics_binomial[i]),"vs mortality"),xlab=paste(gsub("_detected","",interesting_neonics_binomial[i]),"detected?"),ylab="Mortality (relative to hive avg)")
}



```

<br><br>

Regression analysis on concentrations - is mortality higher when neonic loads are higher?
==========================================
<br>

#####Lets start by looking at the just two neonics that we previously identified, as well as a total pollen neonic load:

```{r eval=TRUE, echo=TRUE}

for(i in 1:length(interesting_neonics)){
  fm <- lme(as.formula(paste("mortality ~ ",interesting_neonics[i],
                            sep="")),random=~1|site_code,data=osu_covariate,na.action=na.omit)
  cat("\n","\n",paste("Linear mixed effects regression, ",interesting_neonics[i]," vs mortality:",sep=""),"\n","\n")
  print(summary(fm))
  #print(ranef(fm))  #Note - variance in mortality due to site (random effect) is tiny
  #hist(resid(fm))
  g <- ggplot(osu_covariate,aes_string(interesting_neonics[i],"mortality"))+geom_point(na.rm=T,size=3)+
    geom_smooth(method="lm",formula=y~x,na.rm=T,size=2.5, colour="grey50")+theme_bw()+
    theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) +
    labs(x=paste(interesting_neonics[i],"ng g-1"),y="Relative hive mortality")+geom_hline(yintercept=0)
  print(g)
}
```
<br><br>

Regression analysis on concentrations - are there higher neonic loads when there's more corn nearby?
==========================================
#####Lets look at whether clothianidin, thiamethoxam, or total neonic load in pollen are linked to corn:
```{r eval=TRUE, echo=TRUE}

for(i in 1:length(interesting_neonics)){
  fm <- lme(as.formula(paste(interesting_neonics[i],"~ per_corn * planting",
            sep="")),random=~1|site_code,
            correlation=corAR1(form=~time.block|site_code),
            data=osu_covariate,na.action=na.omit)
  cat("\n",paste("Linear mixed effects regression, ",interesting_neonics[i]," vs percent corn:",sep=""),"\n")
  print(summary(fm)) #variance in pollen neonic conc. due to site is not insignificant except for clothianidin
  #hist(resid(fm))
  
  
  #layout(matrix(1:2))
  acf(resid(fm))
  acf(resid(fm,type="normalized"))
  layout(1)
}

```

Concentrations of these two neonics in pollen, as well as total neonic load, are increased when more corn is planted nearby, but ONLY during defined corn planting periods (see significant percent corn by planting interaction)
<br>
<br>

#####Let's graph percentcorn versus these neonics, by planting period

```{r eval=TRUE, echo=TRUE}

for(i in 1:length(interesting_neonics)){
  g <- ggplot(osu_covariate,aes_string("per_corn",interesting_neonics[i]))+geom_point(na.rm=T,size=2)+
    geom_smooth(method="lm",formula=y~x,na.rm=T,size=2)+facet_wrap(~planting,nrow=1,labeller=label_both)+theme_bw()+
    theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) +
    labs(x="Percent corn within 2 km",y=paste(interesting_neonics[i],"ng g-1"))+
    coord_cartesian(ylim=c(0,150))
  print(g)
}

```

<br><br>

##### Let's do a check to see if there are similar relationships for any other neonics (in pollen or dead bees)
Note: output not shown <br>

```{r eval=FALSE, echo=TRUE}
neonics_to_eval <- colnames(osu_covariate)[which(grepl("FP|DBT",colnames(osu_covariate))& !grepl("FP_clothianidin|FP_thiamethoxam|FP_total_|detected|sample_id",colnames(osu_covariate)))]

for(i in 1:length(neonics_to_eval)){
  fm <- lme(as.formula(paste(neonics_to_eval[i],"~ per_corn * planting",
            sep="")),random=~1|site_code,
            correlation=corAR1(form=~time.block|site_code),
            data=osu_covariate,na.action=na.omit)
  cat("\n",paste("Linear regression, ",neonics_to_eval[i]," vs percent corn:",sep=""),"\n")
  print(summary(fm))
  #hist(resid(fm))
}
```
#####Not seeing any other significant relationships for corn or corn x planting period
<br><br>

Regression analysis on detection - is mortality linked with detection?
==========================================
<br>


```{r eval=TRUE, echo=TRUE}

for(i in 1:length(interesting_neonics_binomial)){
  fm <- lme(as.formula(paste("mortality ~ ",interesting_neonics_binomial[i],
            sep="")),data=osu_covariate,
            correlation = corAR1(form=~time.block|site_code),
            random=~1|site_code,na.action=na.omit)
  cat("\n",paste("Linear regression, ",interesting_neonics_binomial[i]," vs mortality:",sep=""),"\n")
  print(summary(fm))
  #hist(resid(fm))
  
  plot(factor(osu_covariate[,interesting_neonics_binomial[i]],levels = c(0,1),labels=c("No","Yes")),mortality,pch=19,main=paste("Detection of",gsub("_detected","",interesting_neonics_binomial[i]),"vs mortality"),xlab=paste(gsub("_detected","",interesting_neonics_binomial[i]),"detected?"),ylab="Mortality (relative to hive avg)")
  
}


```
<br>

#####Yes, mortality was greater when these two neonics (or any neonics) were detected at any concentration.
<br><br>

Logistic regression analysis - is corn associated with neonic detection?
==========================================
<br>
```{r eval=TRUE, echo=FALSE}

for(i in 1:length(interesting_neonics_binomial)){
  fm <- glmer(as.formula(paste(interesting_neonics_binomial[i],"~ per_corn * planting +(1|site_code)", sep="")),data=osu_covariate,family=binomial(link="logit"),na.action=na.omit,
              glmerControl(optimizer="Nelder_Mead"))
  cat("\n",paste("Logistic regression, ",interesting_neonics_binomial[i]," vs percent corn nearby:",sep=""),"\n")
  print(summary(fm))
  #hist(resid(fm)) 
}

```
<br>

##### The generalized linear mixed effects models do not converge due to the fact that these neonics are always detected during planting periods.
#####If we remove the random effect (site) and fit a logistic regression, we don't see any significant relationships. However we saw above that the corn effect was only during planting periods, and these two neonics have 100% detection rate during planting periods. Therefore, we can't get a good estimate of the corn effect during this critical time. 
<br><br>

##### Let's check to see if using detected/not detected allows us to see significant relationships for any other neonic chemicals vs corn
Note: output not shown

```{r eval=FALSE, echo=TRUE}
neonics_to_eval <- colnames(osu_covariate)[which(grepl("detected",colnames(osu_covariate))& !grepl("FP_clothianidin|FP_thiamethoxam|FP_any_",colnames(osu_covariate)))]
for(i in 1:length(neonics_to_eval)){
  fm <- glmer(as.formula(paste(neonics_to_eval[i],"~ per_corn * planting +(1|site_code)", #Note: not using side ID b/c there are many singularities.
                            sep="")),data=osu_covariate,family=binomial(link="logit"))
  cat("\n",paste("Logistic regression, ",neonics_to_eval[i]," vs percent corn nearby:",sep=""),"\n")
  print(summary(fm))
  #hist(resid(fm)) 
}

```
<br>

#####Using mixed effects models, no significant relationships were found (though some models had poor convergence due to singularities)

#####If we drop the random effect (site) and use regular logistc regression... mo significant relationships found so far for the other neonics in pollen, or anything in dead bees.
<br><br>

Direct link between corn and mortality?
=========================================

```{r eval=TRUE,echo=TRUE}
fm <- lme(mortality~per_corn*planting,random=~1|site_code,
          correlation=corAR1(form=~time.block|site_code),data=osu_covariate)
summary(fm)

g <- ggplot(osu_covariate,aes_string("per_corn","mortality"))+geom_point(na.rm=T)+
    geom_smooth(method="lm",formula=y~x,na.rm=T)+facet_wrap(~planting,nrow=1,labeller=label_both)+theme_bw()+
    theme(panel.grid.major=element_blank(),panel.grid.minor=element_blank()) +
    labs(x="Percent corn within 2 km",y="Relative hive mortality")+geom_hline(yintercept=0)
  print(g)
```
<br>

##### Bee mortality was greater during corn planting periods. There was no relationship with percent corn (though percent corn by planting interaction was borderline significant 0.069).

<br><br><br>

Summary of initial findings
================================
<br>

* During corn planting periods only... there were greater concentrations of two neonic insecticides, **thiamethoxam** and **clothianidin**, and greater **total neonic concentrations** in field pollen when there was more corn planted nearby (within 2 km).
* Greater concentrations of these same neonics, as well as total neonic load, were associated with increased hive mortality.
* Presence of any detectable amount of these neonics, as well as any neonic in general, in pollen was associated with increased hive mortality.
* No significant relationships were found for other neonics, or for concentrations/detection in dead bees

<br><br>


<!-- Summary statistics -->
<!-- ```{r eval=TRUE, echo=TRUE} -->
<!-- str(osu_concs) -->

<!-- #aggregate(osu_concs$conc2, list(osu_concs$neonic), mean) -->
<!-- summary(osu_concs) -->

<!-- neonics <- unique(osu_concs$neonic) -->
<!-- medias <- unique(osu_concs$media) -->
<!-- sites <- unique(osu_concs$site) -->
<!-- site_abbrvs <- unique(osu_concs$site_abbrv) -->
<!-- plot_colors <- c("aquamarine4", "bisque", "blue3", "brown", "chartreuse4", -->
<!--                  "cornflowerblue", "darkgoldenrod3", "darkkhaki", "darkmagenta", "darkorange1") -->
<!-- for(i in 1:10){ #10 -->
<!--   selected_media <- medias[i] -->
<!--   hist_medias <- which(osu_concs$media==selected_media) #7 -->
<!--   for(j in 1:7){ -->
<!--     selected_neonic <- neonics[j] -->
<!--     hist_neonics <- which(osu_concs$neonic==selected_neonic) -->
<!--     hist_intersect <- intersect(hist_neonics, hist_medias) -->
<!--     hist_extract <- osu_concs[hist_intersect,] -->
<!--     plot_title = paste(selected_neonic, "in", selected_media) -->
<!--     n_data <- dim(hist_extract)[[1]] -->
<!--     n_detects <- sum(hist_extract$detected) -->
<!--     min_data <- round(min(hist_extract$conc2), digits=3) -->
<!--     mean_data <- round(mean(hist_extract$conc2), digits=3) -->
<!--     max_data <- round(max(hist_extract$conc2), digits=3) -->
<!--     x_label = paste("ng/g (min, mean, max =", min_data, ",", mean_data,",",max_data,")","\n", -->
<!--                     "detection frequency =", n_detects, "/", n_data) -->
<!--     #plot overall histogram for media and neonic combination -->
<!--     hist(hist_extract$conc2, main = plot_title, xlab=x_label, ylab="Frequency", col=plot_colors[i]) -->
<!--     #plot sideways boxplot by site for each media and neonic combination -->
<!--     boxplot(conc2~site_abbrv,data=hist_extract, main=plot_title, horizontal=TRUE,las=2, col=plot_colors[i]) -->
<!--     #plot sideways barchart of detection proportion by site for each media and neonic combination -->
<!--     detfreq.df <- data.frame(matrix(NA, nrow = 11, ncol = 4)) -->
<!--     colnames(detfreq.df) <- c('site','detects','count','det_prop') -->

<!--     for(k in 1:11){ -->
<!--       selected_site_abbrv <- site_abbrvs[k] -->
<!--       detfreq.df$site[k] <- selected_site_abbrv -->
<!--       which_extract_site <- which(hist_extract$site_abbrv==selected_site_abbrv) -->
<!--       site_extract <- hist_extract[which_extract_site,] -->
<!--       n_data_site <- dim(hist_extract)[[1]] -->
<!--       detfreq.df$count[k] <- n_data_site -->
<!--       n_detects_site <- sum(hist_extract$detected) -->
<!--       detfreq.df$detects[k] <- n_detects_site -->
<!--       if(n_data_site >0){ -->
<!--         det_prop_site <- n_detects_site/n_data_site -->
<!--       }else{ -->
<!--         det_prop_site <- 0 -->
<!--       } -->
<!--       detfreq.df$det_prop[k] <- det_prop_site -->
<!--     } -->
<!--     #plot time series by site for each media and neonic combination -->
<!--     barplot(detfreq.df$det_prop,main="Page Views", horiz=TRUE,names.arg=detfreq.df$site,las=1) -->
<!--   } -->
<!-- } -->

<!-- ``` -->
